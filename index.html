<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte du Pivot</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map {
            height: 80vh;
            width: 100%;
        }
        #legend {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 5;
        }
        .orientation-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
        .orientation-buttons button {
            margin: 5px;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .orientation-buttons button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="legend">
        <h4>Légende du Pivot</h4>
        <p><strong>Angle de travail :</strong> L'angle total du pivot, 180° = demi-cercle, 360° = cercle complet, etc.</p>
    </div>
    <div class="orientation-buttons">
        <button id="orientation-minus">Orientation -</button>
        <button id="orientation-plus">Orientation +</button>
    </div>

    <script>
        // Fonction pour récupérer un paramètre d'URL
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return parseFloat(urlParams.get(name));
        }

        // Initialisation de l'orientation (mémorisation dans localStorage)
        let currentOrientation = parseFloat(localStorage.getItem('currentOrientation')) || getQueryParam("orientation") || 0;

        // Sauvegarde de l'orientation dans localStorage
        function saveOrientation() {
            localStorage.setItem('currentOrientation', currentOrientation);
        }

        // Fonction pour dessiner le pivot
        function drawPivotArc(lat, lon, orientation, angle) {
            let radius = 100; // Rayon du cercle
            let startAngle = orientation; // L'orientation du pivot (en degrés)

            let remainingAngle = angle;
            let currentStartAngle = startAngle;

            while (remainingAngle > 0) {
                let arcAngle = Math.min(remainingAngle, 360);
                let endAngle = (currentStartAngle + arcAngle) % 360;

                let startRad = currentStartAngle * (Math.PI / 180);
                let endRad = endAngle * (Math.PI / 180);

                L.circle([lat, lon], {
                    color: 'blue',
                    fillColor: 'blue',
                    fillOpacity: 0.3,
                    radius: radius,
                    startAngle: startRad,
                    endAngle: endRad,
                }).addTo(map);

                currentStartAngle = endAngle;
                remainingAngle -= arcAngle;
            }
        }

        // Fonction pour initialiser la carte
        function initMap() {
            let lat0 = getQueryParam("lat0") || 45.1234;
            let lon0 = getQueryParam("lon0") || 2.3456;
            let angle = getQueryParam("angle") || 180;

            map = L.map('map').setView([lat0, lon0], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            let markerPivot = L.marker([lat0, lon0]).addTo(map).bindPopup('Pivot');

            drawPivotArc(lat0, lon0, currentOrientation, angle);
        }

        // Fonction pour ajuster l'orientation (ajustement à ±1°)
        function adjustOrientation(offset) {
            // Ajouter ou soustraire 1° à l'orientation
            currentOrientation = (currentOrientation + offset) % 360;
            if (currentOrientation < 0) {
                currentOrientation += 360; // Pour éviter les valeurs négatives
            }

            // Assurer que l'orientation reste entre 0° et 360°
            if (currentOrientation >= 360) {
                currentOrientation = 0; // Si l'orientation dépasse 360°, recommence à 0°
            } else if (currentOrientation < 0) {
                currentOrientation = 360; // Si l'orientation est inférieure à 0°, recommence à 360°
            }

            // Mettre à jour le stockage local
            saveOrientation();

            // Rafraîchir la carte pour refléter la nouvelle orientation
            initMap();
        }

        // Ajouter les événements pour les boutons
        document.getElementById('orientation-minus').addEventListener('click', function() {
            adjustOrientation(-1); // Soustraire 1° à l'orientation
        });

        document.getElementById('orientation-plus').addEventListener('click', function() {
            adjustOrientation(1); // Ajouter 1° à l'orientation
        });

        // Initialisation de la carte à l'ouverture de la page
        window.onload = initMap;
    </script>
</body>
</html>
