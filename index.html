<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte GPS Pivot</title>

    <!-- Importation de Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map { width: 100%; height: 700px; }
        
        /* Panneau d'informations repositionné en haut à droite */
        #infoPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="infoPanel">
        <b>Date et Heure :</b> <span id="dateTime"></span><br>
        <b>Météo :</b> <span id="weather">Chargement...</span>
    </div>

    <div id="map"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Récupération des paramètres URL
            const originLat = parseFloat(urlParams.get("originLat"));
            const originLon = parseFloat(urlParams.get("originLon"));
            const trackerLat = parseFloat(urlParams.get("trackerLat"));
            const trackerLon = parseFloat(urlParams.get("trackerLon"));

            // Vérification des coordonnées
            if (isNaN(originLat) || isNaN(originLon) || isNaN(trackerLat) || isNaN(trackerLon)) {
                alert("Mauvaises coordonnées !");
                return;
            }

            // Affichage de la date et l'heure
            function updateDateTime() {
                const now = new Date();
                document.getElementById("dateTime").textContent = now.toLocaleString();
            }
            updateDateTime();
            setInterval(updateDateTime, 60000); // Mise à jour toutes les minutes

            // Création de la carte centrée sur le point d'origine
            const map = L.map('map').setView([originLat, originLon], 17);

            // Utilisation d'une carte satellite réaliste (ESRI)
            L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
                attribution: '© Esri, Maxar, Earthstar Geographics',
                maxZoom: 19
            }).addTo(map);

            // Ajout des marqueurs
            L.marker([originLat, originLon]).addTo(map).bindPopup("Point d'origine").openPopup();
            L.marker([trackerLat, trackerLon]).addTo(map).bindPopup("Tracker GPS");

            // Ligne entre les deux points
            L.polyline([[originLat, originLon], [trackerLat, trackerLon]], { color: 'blue', weight: 3 }).addTo(map);

            // Cercle autour du pivot
            const pivotRadius = map.distance([originLat, originLon], [trackerLat, trackerLon]) / 2;
            L.circle([originLat, originLon], {
                color: 'blue', fillColor: 'rgba(0, 0, 255, 0.3)', fillOpacity: 0.4, radius: pivotRadius
            }).addTo(map);

            // Récupération des données météo MET Norway (Yr.no)
            fetch(`https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${originLat}&lon=${originLon}`, {
                headers: { "User-Agent": "GPS_Pivot/1.0" }
            })
            .then(response => response.json())
            .then(data => {
                const temperature = data.properties.timeseries[0].data.instant.details.air_temperature;
                const weatherDesc = data.properties.timeseries[0].data.next_1_hours.summary.symbol_code.replace('_', ' ');
                document.getElementById("weather").textContent = `${temperature}°C - ${weatherDesc}`;
            })
            .catch(error => {
                console.error("Erreur météo :", error);
                document.getElementById("weather").textContent = "Indisponible";
            });
        });
    </script>
</body>
</html>
