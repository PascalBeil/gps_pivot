<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Pivot Irrigation</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { width: 100%; height: 100vh; }
        #weatherPanel { position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.7); padding: 10px; border-radius: 8px; }
        .line { color: blue; weight: 2; }
        .dashedLine { color: black; weight: 4; dashArray: '5,5'; }
        .arc { color: yellow; weight: 4; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="weatherPanel">
    <h4>Météo</h4>
    <p>Température : <span id="temp">Chargement...</span></p>
    <p>Hygrométrie : <span id="humidity">Chargement...</span></p>
    <p>Risque de pluie : <span id="rainChance">Chargement...</span></p>
    <p>État du pivot : <span id="pivotState">Inconnu</span></p>
    <p>Sens de marche : <span id="pivotDirection">Inconnu</span></p>
    <p>Angle actuel : <span id="currentAngle">0°</span></p>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil/leaflet.geometryutil.js"></script>
<script>
    // Récupérer les paramètres de l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const latFixed = parseFloat(urlParams.get('latFixed'));
    const lonFixed = parseFloat(urlParams.get('lonFixed'));
    const latLastTower = parseFloat(urlParams.get('latLastTower'));
    const lonLastTower = parseFloat(urlParams.get('lonLastTower'));
    const latZero = parseFloat(urlParams.get('latZero'));
    const lonZero = parseFloat(urlParams.get('lonZero'));
    const pivotDirection = parseInt(urlParams.get('pivotDirection'));
    const pivotState = parseInt(urlParams.get('pivotState'));
    const maxAngle = parseInt(urlParams.get('maxAngle'));
    const currentAngle = parseInt(urlParams.get('currentAngle'));

    // Initialisation de la carte avec OpenStreetMap
    const map = L.map('map').setView([latFixed, lonFixed], 14);
    L.tileLayer('https://{s}.tile.stamen.com/terrain/{z}/{x}/{y}.jpg').addTo(map);  // Carte satellite gratuite

    // Tracer les points
    L.marker([latFixed, lonFixed]).addTo(map).bindPopup('Point Fixe');
    L.marker([latZero, lonZero]).addTo(map).bindPopup('Point Zéro');
    L.marker([latLastTower, lonLastTower]).addTo(map).bindPopup('Dernière Tour');

    // Fonction pour dessiner un arc de cercle entre le point zéro et la dernière tour
    function drawArc(map, lat1, lon1, lat2, lon2) {
        const latLng1 = L.latLng(lat1, lon1);
        const latLng2 = L.latLng(lat2, lon2);
        
        // Utiliser GeometryUtil pour dessiner un arc
        L.GeometryUtil.geodesic(map, latLng1, latLng2, {color: 'yellow', weight: 3}).addTo(map);
    }

    // Tracer l'arc entre le point Zéro et la Dernière Tour
    drawArc(map, latZero, lonZero, latLastTower, lonLastTower);

    // Tracer la ligne en pointillés entre le Point Fixe et le Point Zéro
    L.polyline([[latFixed, lonFixed], [latZero, lonZero]], {color: 'black', weight: 4, dashArray: '5,5'}).addTo(map);

    // Tracer la ligne solide entre le Point Fixe et la Dernière Tour
    L.polyline([[latFixed, lonFixed], [latLastTower, lonLastTower]], {color: 'blue', weight: 4}).addTo(map);

    // Panneau météo (données fictives ici, pas d'API pour météo dans ce code)
    document.getElementById('temp').textContent = '18°C';
    document.getElementById('humidity').textContent = '80%';
    document.getElementById('rainChance').textContent = '20%';

    // État du pivot et direction
    let pivotStateText = "Inconnu";
    if (pivotState === 1) pivotStateText = "En marche";
    if (pivotState === 2) pivotStateText = "En défaut";
    document.getElementById('pivotState').textContent = pivotStateText;

    let pivotDirectionText = "Inconnu";
    if (pivotDirection === 1) pivotDirectionText = "Avant";
    if (pivotDirection === 2) pivotDirectionText = "Arrière";
    document.getElementById('pivotDirection').textContent = pivotDirectionText;

    // Angle actuel
    document.getElementById('currentAngle').textContent = `${currentAngle}°`;
</script>

</body>
</html>
