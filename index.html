<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Pivot avec Météo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 500px; }
        #weather { margin-top: 10px; font-size: 16px; font-weight: bold; }
        .button-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        button {
            margin: 5px;
        }
    </style>
</head>
<body>

    <!-- Affichage de la carte -->
    <div id="map"></div>

    <!-- Légende météo -->
    <div id="weather">Chargement de la météo...</div>

    <!-- Boutons pour ajuster l'orientation -->
    <div class="button-container">
        <button id="btnOrientationMinus">Orientation -</button>
        <button id="btnOrientationPlus">Orientation +</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let orientationOffset = 0;

        // Fonction pour récupérer les paramètres de l'URL
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                lat0: parseFloat(urlParams.get('lat0') || 45.1234),
                lon0: parseFloat(urlParams.get('lon0') || 2.3456),
                lat1: parseFloat(urlParams.get('lat1') || 45.2234),
                lon1: parseFloat(urlParams.get('lon1') || 2.4456),
                orientation: parseFloat(urlParams.get('orientation') || 0),
                angle: parseFloat(urlParams.get('angle') || 360),
                pivotStatus: urlParams.get('pivotStatus') || 'normal',
                marchingDirection: urlParams.get('marchingDirection') || 'horaire'
            };
        }

        // Fonction pour récupérer la météo
        function getWeather(lat, lon) {
            const url = `https://wttr.in/${lat},${lon}?format=%C+%t+%p`;
            fetch(url)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('weather').textContent = `Météo: ${data}`;
                })
                .catch(error => {
                    document.getElementById('weather').textContent = "Météo non disponible";
                    console.error("Erreur météo:", error);
                });
        }

        // Fonction pour dessiner la carte
        function drawMap(lat0, lon0, lat1, lon1, orientation, angle, pivotStatus, marchingDirection) {
            var map = L.map('map').setView([lat0, lon0], 13);

            // Ajouter une carte OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Ajouter les marqueurs pour les deux points
            L.marker([lat0, lon0]).addTo(map).bindPopup("Point d'origine");
            L.marker([lat1, lon1]).addTo(map).bindPopup("Point mobile");

            // Ajouter une ligne entre les deux points
            const lineColor = pivotStatus === 'normal' ? 'blue' : 'red';
            L.polyline([[lat0, lon0], [lat1, lon1]], { color: lineColor }).addTo(map);

            // Affichage du sens de marche et de l’état du pivot
            L.marker([lat0, lon0]).addTo(map).bindPopup(`Sens de marche: ${marchingDirection}`).openPopup();
            L.marker([lat1, lon1]).addTo(map).bindPopup(`État du pivot: ${pivotStatus}`).openPopup();

            // Gestion du pivotflex (angle > 360°)
            let radius = 1000;
            let fullCircles = Math.floor(angle / 360);
            let remainingAngle = angle % 360;

            for (let i = 0; i < fullCircles; i++) {
                L.circle([lat0, lon0], {
                    color: 'blue',
                    fillColor: 'blue',
                    fillOpacity: 0.3,
                    radius: radius
                }).addTo(map);
            }

            if (remainingAngle > 0) {
                let startRad = (orientation + orientationOffset) * (Math.PI / 180);
                let endRad = (orientation + orientationOffset + remainingAngle) * (Math.PI / 180);
                L.circle([lat0, lon0], {
                    color: 'blue',
                    fillColor: 'blue',
                    fillOpacity: 0.3,
                    radius: radius,
                    startAngle: startRad,
                    endAngle: endRad
                }).addTo(map);
            }
        }

        // Fonction qui charge la carte et la météo
        function loadPage() {
            const { lat0, lon0, lat1, lon1, orientation, angle, pivotStatus, marchingDirection } = getUrlParams();
            drawMap(lat0, lon0, lat1, lon1, orientation, angle, pivotStatus, marchingDirection);
            getWeather(lat0, lon0);
        }

        // Gestion des boutons pour ajuster l'orientation
        function adjustOrientation(increment) {
            orientationOffset = (orientationOffset + increment + 360) % 360;
            loadPage();
        }

        document.getElementById('btnOrientationMinus').addEventListener('click', () => adjustOrientation(-1));
        document.getElementById('btnOrientationPlus').addEventListener('click', () => adjustOrientation(1));

        // Chargement initial
        window.onload = loadPage;
    </script>

</body>
</html>
