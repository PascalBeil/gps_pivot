<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Pivot avec Météo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 500px; }
        .info-box {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            font-size: 14px;
            font-weight: bold;
        }
        .button-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        button {
            margin: 5px;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <!-- Panneau d'infos météo et état du pivot -->
    <div id="infoBox" class="info-box">
        <div id="weather">Météo : Chargement...</div>
        <div id="pivotStatus">État du pivot : Inconnu</div>
        <div id="marchingDirection">Sens de marche : Inconnu</div>
        <div id="weatherIcon"><img id="weatherIconImage" src="" alt="Météo" width="50" /></div>
    </div>

    <!-- Boutons d'orientation -->
    <div class="button-container">
        <button id="btnOrientationMinus">Orientation -</button>
        <button id="btnOrientationPlus">Orientation +</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let orientationOffset = 0;

        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                lat0: parseFloat(urlParams.get('lat0') || 45.1234),
                lon0: parseFloat(urlParams.get('lon0') || 2.3456),
                lat1: parseFloat(urlParams.get('lat1') || 45.2234),
                lon1: parseFloat(urlParams.get('lon1') || 2.4456),
                orientation: parseFloat(urlParams.get('orientation') || 0),
                angle: parseFloat(urlParams.get('angle') || 360),
                pivotStatus: urlParams.get('pivotStatus') || 'normal',
                marchingDirection: urlParams.get('marchingDirection') || 'horaire'
            };
        }

        // Récupération de la météo via wttr.in
        function getWeather(lat, lon) {
            const url = `https://wttr.in/${lat},${lon}?format=%C+%t+%p+%w`; // Météo complète avec icône et condition
            fetch(url)
                .then(response => response.text())
                .then(data => {
                    const weatherData = data.split(" ");
                    document.getElementById('weather').textContent = `Météo : ${weatherData[0]}`;
                    document.getElementById('weatherIconImage').src = `https://wttr.in/${lat},${lon}.png?m`;
                })
                .catch(error => {
                    document.getElementById('weather').textContent = "Météo non disponible";
                    console.error("Erreur météo:", error);
                });
        }

        // Fonction de calcul de la distance entre deux points
        function calculateDistance(lat0, lon0, lat1, lon1) {
            const R = 6371000; // Rayon de la Terre en mètres
            const dLat = (lat1 - lat0) * Math.PI / 180;
            const dLon = (lon1 - lon0) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat0 * Math.PI / 180) * Math.cos(lat1 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Dessiner la carte avec les deux points et le cercle ou arc
        function drawMap(lat0, lon0, lat1, lon1, orientation, angle, pivotStatus, marchingDirection) {
            var map = L.map('map').setView([lat0, lon0], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Marqueurs pour les points fixes
            L.marker([lat0, lon0]).addTo(map).bindPopup("Point d'origine");
            L.marker([lat1, lon1]).addTo(map).bindPopup("Point mobile");

            // Ligne entre les points (bleue si normal, rouge si problème)
            const lineColor = pivotStatus === 'normal' ? 'blue' : 'red';
            L.polyline([[lat0, lon0], [lat1, lon1]], { color: lineColor }).addTo(map);

            // Mise à jour des infos
            document.getElementById('pivotStatus').textContent = `État du pivot : ${pivotStatus}`;
            document.getElementById('marchingDirection').textContent = `Sens de marche : ${marchingDirection}`;

            // Calcul du rayon basé sur la distance entre les deux points
            let radius = calculateDistance(lat0, lon0, lat1, lon1);

            // Gestion du pivotflex et affichage du cercle / arc
            let remainingAngle = angle % 360;
            let startRad = ((orientation + orientationOffset) % 360) * (Math.PI / 180);
            let endRad = ((orientation + orientationOffset + remainingAngle) % 360) * (Math.PI / 180);

            // Affichage du cercle complet si l'angle est de 360°
            if (remainingAngle === 360 || angle >= 360) {
                L.circle([lat0, lon0], {
                    color: 'blue',
                    fillColor: 'blue',
                    fillOpacity: 0.3,
                    radius: radius
                }).addTo(map);
            }

            // Affichage du demi-cercle ou arc dans le sens de marche
            if (remainingAngle > 0) {
                const arc = L.semiCircle([lat0, lon0], {
                    radius: radius,
                    color: 'yellow',
                    fillColor: 'yellow',
                    fillOpacity: 0.5
                }).setDirection(startRad * (180 / Math.PI), endRad * (180 / Math.PI));
                arc.addTo(map);
            }
        }

        // Chargement de la page avec les paramètres URL
        function loadPage() {
            const { lat0, lon0, lat1, lon1, orientation, angle, pivotStatus, marchingDirection } = getUrlParams();
            drawMap(lat0, lon0, lat1, lon1, orientation, angle, pivotStatus, marchingDirection);
            getWeather(lat0, lon0);
        }

        // Ajuster l'orientation
        function adjustOrientation(increment) {
            orientationOffset = (orientationOffset + increment + 360) % 360;
            loadPage();
        }

        document.getElementById('btnOrientationMinus').addEventListener('click', () => adjustOrientation(-1));
        document.getElementById('btnOrientationPlus').addEventListener('click', () => adjustOrientation(1));

        window.onload = loadPage;
    </script>

</body>
</html>
