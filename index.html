<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte GPS Pivot</title>

    <!-- Importation de Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map { width: 100%; height: 700px; }

        /* Panneau m√©t√©o repositionn√© et bien visible */
        #infoPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="infoPanel">
        <b>üìÖ Date et Heure :</b> <span id="dateTime"></span><br>
        <b>üå°Ô∏è M√©t√©o :</b> <span id="weather">Chargement...</span><br>
        <b>üíß Humidit√© :</b> <span id="humidity">...</span> %<br>
        <b>üåßÔ∏è Risque de pluie :</b> <span id="precipitation">...</span> %
    </div>

    <div id="map"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);

            // R√©cup√©ration des param√®tres URL
            const originLat = parseFloat(urlParams.get("originLat"));
            const originLon = parseFloat(urlParams.get("originLon"));
            const trackerLat = parseFloat(urlParams.get("trackerLat"));
            const trackerLon = parseFloat(urlParams.get("trackerLon"));

            if (isNaN(originLat) || isNaN(originLon) || isNaN(trackerLat) || isNaN(trackerLon)) {
                alert("Mauvaises coordonn√©es !");
                return;
            }

            function updateDateTime() {
                const now = new Date();
                document.getElementById("dateTime").textContent = now.toLocaleString();
            }
            updateDateTime();
            setInterval(updateDateTime, 60000);

            const map = L.map('map').setView([originLat, originLon], 17);

            L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
                attribution: '¬© Esri, Maxar, Earthstar Geographics',
                maxZoom: 19
            }).addTo(map);

            L.marker([originLat, originLon]).addTo(map).bindPopup("Point d'origine").openPopup();
            L.marker([trackerLat, trackerLon]).addTo(map).bindPopup("Tracker GPS");

            L.polyline([[originLat, originLon], [trackerLat, trackerLon]], { color: 'blue', weight: 3 }).addTo(map);

            function distance(lat1, lon1, lat2, lon2) {
                const R = 6371e3;
                const œÜ1 = lat1 * Math.PI / 180;
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                          Math.cos(œÜ1) * Math.cos(œÜ2) *
                          Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }
            const pivotLength = distance(originLat, originLon, trackerLat, trackerLon);

            L.circle([originLat, originLon], {
                color: 'yellow',
                fillColor: 'rgba(255, 255, 0, 0.3)',
                fillOpacity: 0.4,
                radius: pivotLength * 2 // Le diam√®tre du cercle est maintenant 2x la longueur totale du pivot
            }).addTo(map);

            // R√©cup√©ration des donn√©es m√©t√©o corrig√©e
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${originLat}&longitude=${originLon}&current=temperature_2m,relative_humidity_2m,precipitation_probability&timezone=auto`)
            .then(response => response.json())
            .then(data => {
                if (data.current) {
                    document.getElementById("weather").textContent = data.current.temperature_2m + "¬∞C";
                    document.getElementById("humidity").textContent = data.current.relative_humidity_2m;
                    document.getElementById("precipitation").textContent = data.current.precipitation_probability || "0";
                }
            })
            .catch(error => {
                console.error("Erreur m√©t√©o :", error);
                document.getElementById("weather").textContent = "N/A";
                document.getElementById("humidity").textContent = "N/A";
                document.getElementById("precipitation").textContent = "N/A";
            });
        });
    </script>
</body>
</html>