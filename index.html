<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte GPS Pivot</title>

    <!-- Importation de Leaflet.js pour OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        /* Définition de la taille de la carte (augmentée en hauteur) */
        #map { width: 100%; height: 700px; } /* Augmenter la hauteur de la carte */
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        /**
         * Script pour afficher un pivot d'irrigation et un tracker GPS sur une carte OpenStreetMap avec un zoom élevé.
         * 
         * Fonctionnalités :
         * - Récupère les coordonnées depuis l'URL.
         * - Vérifie et affiche des erreurs si les coordonnées sont invalides.
         * - Charge la carte OpenStreetMap avec Leaflet.js.
         * - Affiche deux marqueurs : point d'origine et tracker GPS.
         * - Relie les deux points avec une ligne bleue.
         * - Dessine un cercle autour du point d'origine pour représenter le pivot d'irrigation.
         * 
         * Exemple d'URL :
         * https://votrepage.github.io/gps_pivot/?originLat=43.2486&originLon=3.2925&trackerLat=43.2500&trackerLon=3.2950
         */

        document.addEventListener("DOMContentLoaded", function () {
            // Vérifier que Leaflet est bien chargé
            if (typeof L === "undefined") {
                alert("Erreur : Leaflet.js ne s'est pas chargé correctement !");
                console.error("Leaflet.js est introuvable. Vérifiez votre connexion internet.");
                return;
            }

            // Récupération des paramètres depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const originLat = parseFloat(urlParams.get("originLat"));
            const originLon = parseFloat(urlParams.get("originLon"));
            const trackerLat = parseFloat(urlParams.get("trackerLat"));
            const trackerLon = parseFloat(urlParams.get("trackerLon"));

            // Vérification des coordonnées (si elles sont bien des nombres valides)
            if (isNaN(originLat) || isNaN(originLon) || isNaN(trackerLat) || isNaN(trackerLon)) {
                alert("Mauvaises coordonnées ! Vérifiez l'URL.");
                console.error("Coordonnées invalides :", { originLat, originLon, trackerLat, trackerLon });
                return;
            }

            console.log("Coordonnées reçues :", { originLat, originLon, trackerLat, trackerLon });

            // Création de la carte centrée sur le point d'origine avec une vue OpenStreetMap et un zoom élevé
            const map = L.map('map').setView([originLat, originLon], 15); // Niveau de zoom initial à 15

            // Charger les tuiles OpenStreetMap avec un zoom maximal de 18
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18 // Zoom maximal de 18
            }).addTo(map);

            // Ajout des marqueurs sur la carte
            const originMarker = L.marker([originLat, originLon]).addTo(map)
                .bindPopup("Point d'origine").openPopup();

            const trackerMarker = L.marker([trackerLat, trackerLon]).addTo(map)
                .bindPopup("Tracker GPS");

            // Ajout d'une ligne reliant les deux points
            const line = L.polyline([[originLat, originLon], [trackerLat, trackerLon]], {
                color: 'blue',
                weight: 3
            }).addTo(map);

            // Calculer la distance entre les deux points
            const distance = map.distance([originLat, originLon], [trackerLat, trackerLon]);
            const pivotRadius = distance / 2; // Rayon ajusté en fonction de la distance

            // Ajout d'un cercle autour du point d'origine pour représenter la zone du pivot
            const pivotCircle = L.circle([originLat, originLon], {
                color: 'blue', // Contour du cercle
                fillColor: 'rgba(0, 0, 255, 0.3)', // Remplissage bleu clair
                fillOpacity: 0.4,
                radius: pivotRadius // Rayon dynamique basé sur la distance
            }).addTo(map);

            console.log("Carte OpenStreetMap avec zoom élevé chargée avec succès !");
        });
    </script>
</body>
</html>
