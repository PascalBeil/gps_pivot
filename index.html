<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte GPS Pivot</title>

    <!-- Importation de Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map { width: 100%; height: 700px; }

        /* Panneau mÃ©tÃ©o repositionnÃ© et bien visible */
        #infoPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="infoPanel">
        <b>ğŸ“… Date et Heure :</b> <span id="dateTime"></span><br>
        <b>ğŸŒ¡ï¸ MÃ©tÃ©o :</b> <span id="weather">Chargement...</span><br>
        <b>ğŸ’§ HumiditÃ© :</b> <span id="humidity">...</span> %<br>
        <b>ğŸŒ§ï¸ Risque de pluie :</b> <span id="precipitation">...</span> %
    </div>

    <div id="map"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);

            // RÃ©cupÃ©ration des paramÃ¨tres URL
            const originLat = parseFloat(urlParams.get("originLat"));
            const originLon = parseFloat(urlParams.get("originLon"));
            const trackerLat = parseFloat(urlParams.get("trackerLat"));
            const trackerLon = parseFloat(urlParams.get("trackerLon"));

            if (isNaN(originLat) || isNaN(originLon) || isNaN(trackerLat) || isNaN(trackerLon)) {
                alert("Mauvaises coordonnÃ©es !");
                return;
            }

            function updateDateTime() {
                const now = new Date();
                document.getElementById("dateTime").textContent = now.toLocaleString();
            }
            updateDateTime();
            setInterval(updateDateTime, 60000);

            const map = L.map('map').setView([originLat, originLon], 17);

            L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
                attribution: 'Â© Esri, Maxar, Earthstar Geographics',
                maxZoom: 19
            }).addTo(map);

            L.marker([originLat, originLon]).addTo(map).bindPopup("Point d'origine").openPopup();
            L.marker([trackerLat, trackerLon]).addTo(map).bindPopup("Tracker GPS");

            L.polyline([[originLat, originLon], [trackerLat, trackerLon]], { color: 'blue', weight: 3 }).addTo(map);

            const centerLat = (originLat + trackerLat) / 2;
            const centerLon = (originLon + trackerLon) / 2;

            function distance(lat1, lon1, lat2, lon2) {
                const R = 6371e3;
                const Ï†1 = lat1 * Math.PI / 180;
                const Ï†2 = lat2 * Math.PI / 180;
                const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
                const Î”Î» = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                          Math.cos(Ï†1) * Math.cos(Ï†2) *
                          Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }
            const radius = distance(originLat, originLon, trackerLat, trackerLon) / 2 * Math.SQRT2;

            L.circle([centerLat, centerLon], {
                color: 'yellow',
                fillColor: 'rgba(255, 255, 0, 0.3)',
                fillOpacity: 0.4,
                radius: radius
            }).addTo(map);

            // RÃ©cupÃ©ration des donnÃ©es mÃ©tÃ©o et conversion du risque de pluie en %
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${originLat}&longitude=${originLon}&current=temperature_2m,weathercode,relative_humidity_2m,precipitation_probability&timezone=auto`)
            .then(response => response.json())
            .then(data => {
                const precipitation = data.current.precipitation_probability || 0;
                document.getElementById("precipitation").textContent = precipitation;
            })
            .catch(error => {
                console.error("Erreur mÃ©tÃ©o :", error);
                document.getElementById("precipitation").textContent = "N/A";
            });
        });
    </script>
</body>
</html>